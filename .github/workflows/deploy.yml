name: Deploy to Netlify

on:
  push:
    branches: [main]  # –ó–∞–ø—É—Å–∫–∞—Ç—å –ø—Ä–∏ –ø—É—à–µ –≤ main
  pull_request:       # –ó–∞–ø—É—Å–∫–∞—Ç—å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–µ–≤—å—é –ø—Ä–∏ Pull Request

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    env:
      NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
      NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npm run lint:check

      #- name: Test
      #  run: npm run test

      - name: Build
        run: npm run build

      # –î–µ–ø–ª–æ–π –¥–ª—è Pull Request (—Å–æ–∑–¥–∞—Å—Ç –ø—Ä–µ–≤—å—é)
      - name: Deploy Preview
        id: deploy-preview
        if: github.event_name == 'pull_request'
        run: |
          output=$(npx netlify-cli deploy --site $NETLIFY_SITE_ID --dir=./dist --json)
          echo "preview_url=$(echo $output | jq -r .deploy_url)" >> $GITHUB_OUTPUT

      # –î–æ–±–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞ preview –≤ pull request (–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –µ–≥–æ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –¥–µ–ø–ª–æ–µ)
      - name: Add Comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-deploy
          message: |
            ## üöÄ Preview deployed
            **URL:** ${{ steps.deploy-preview.outputs.preview_url }}

            _Updated on every push._

      # –î–µ–ø–ª–æ–π –≤ –ø—Ä–æ–¥–∞–∫—à–Ω (–ø—Ä–∏ –ø—É—à–µ –≤ main)
      # –î–∞—ë—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Ä–µ–≤—å—é –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∏—á –±–µ–∑ —Ä–∏—Å–∫–∞ —Å–ª–æ–º–∞—Ç—å –ø—Ä–æ–¥–∞–∫—à–Ω
      - name: Deploy to Production
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: npx netlify-cli deploy --prod --site $NETLIFY_SITE_ID --dir=./dist